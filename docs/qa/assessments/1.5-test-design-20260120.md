# Test Design: Story 1.5 - API de Génération de Questions ICE

Date: 2026-01-20
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 15
- Unit tests: 6 (40%)
- Integration tests: 8 (53%)
- E2E tests: 0 (0%) - *Story is Backend Only*
- Manual/Qualitative: 1 (7%)
- Priority distribution: P0: 7, P1: 7, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1: Endpoint et Validation

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 1.5-INT-001 | Integration | P0 | POST /api/quiz/generate Phase 1 returns 200 | Critical path for starting the quiz |
| 1.5-INT-003 | Integration | P1 | Returns 400 on invalid payload | Validates request schema enforcement |
| 1.5-UNIT-004 | Unit | P0 | Topic sanitization prevents prompt injection | Mitigates SEC-001 (Security) |

### AC2: Génération - Phase 1 (Polarisation)

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 1.5-UNIT-005 | Unit | P1 | Zod schema validates Phase 1 response | Ensures data integrity from LLM |
| 1.5-INT-001 | Integration | P0 | Verify 6 questions returned for Phase 1 | Core functionality requirement |

### AC3: Génération - Phase 2 (Affinage)

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 1.5-INT-002 | Integration | P0 | POST /api/quiz/generate Phase 2 returns 200 | Critical path for quiz completion |
| 1.5-INT-004 | Integration | P1 | Returns 400 on Phase 2 without context | Requirement enforcement |
| 1.5-UNIT-006 | Unit | P1 | Zod schema validates Phase 2 response | Ensures data integrity for complex context |

### AC4: Sécurité, Robustesse et Performance

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 1.5-UNIT-001 | Unit | P0 | `cleanJsonResponse` handles markdown wrappers | Mitigates TECH-001 (Critical Risk) |
| 1.5-UNIT-002 | Unit | P0 | `cleanJsonResponse` handles extra text | Mitigates TECH-001 (Critical Risk) |
| 1.5-INT-005 | Integration | P1 | Retries 2 times on Gemini 5xx | Ensures robustness (TECH-001) |
| 1.5-INT-006 | Integration | P1 | Returns 502 after maximum retries | Graceful failure handling |
| 1.5-INT-007 | Integration | P0 | Returns 502 on unfixable malformed JSON | Protects system from bad data |
| 1.5-INT-008 | Integration | P0 | API Key is not leaked in response/logs | Mitigates SEC-002 |
| 1.5-INT-009 | Integration | P2 | Response time < 10s (simulated latency) | Validates PERF-001 |

### Qualitative Review

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 1.5-MAN-001 | Manual | P1 | Qualitative review of generated questions | Mitigates BUS-001 (Relevance) |

## Risk Coverage

| Risk ID | Mitigating Test(s) |
| --- | --- |
| **TECH-001** (Gemini Format) | 1.5-UNIT-001, 1.5-UNIT-002, 1.5-INT-005, 1.5-INT-007 |
| **SEC-001** (Injection) | 1.5-UNIT-004 |
| **DATA-001** (IDs/Dimensions) | 1.5-UNIT-005, 1.5-UNIT-006 |
| **BUS-001** (Quality) | 1.5-MAN-001 |
| **PERF-001** (Latency) | 1.5-INT-009 |
| **SEC-002** (Key Leak) | 1.5-INT-008 |

## Recommended Execution Order

1. **P0 Unit tests** (1.5-UNIT-001, 002, 004): Validate core logic and security first.
2. **P0 Integration tests** (1.5-INT-001, 002, 007, 008): Verify critical API flows.
3. **P1 tests**: Robustness and data integrity validation.
4. **Manual review**: Once technical stability is confirmed.

```yaml
test_design:
  scenarios_total: 15
  by_level:
    unit: 6
    integration: 8
    e2e: 0
    manual: 1
  by_priority:
    p0: 7
    p1: 7
    p2: 1
  coverage_gaps: []
```
