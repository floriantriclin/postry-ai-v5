# Évaluation des Risques - Story 2.4 (Reveal Flow & Persistance)

**Date:** 2026-01-23
**Auteur:** BMad Scrum Master

## 1. Analyse des Risques de Sécurité (Security NFRs)

### 1.1. Protection des Données "Pending"
*   **Risque:** Les posts stockés avec un email mais sans `user_id` sont vulnérables si le RLS n'est pas strictement configuré.
*   **Mitigation:**
    *   L'insertion doit se faire **uniquement** via l'API Route server-side (`/api/quiz/pre-persist`) utilisant la clé `SERVICE_ROLE`.
    *   Le RLS sur la table `posts` **NE DOIT PAS** autoriser l'INSERT public/anonyme.
    *   Le champ `email` ne doit jamais être exposé via une API publique de listing.

### 1.2. Usurpation de Flux (Replay Attack)
*   **Risque:** Un attaquant pourrait spammer l'endpoint `pre-persist` avec des emails aléatoires.
*   **Mitigation:**
    *   Implémenter un Rate Limiting strict sur l'endpoint (par IP).
    *   Valider strictement le format de l'email (Zod).

### 1.3. Détournement de Session
*   **Risque:** Un utilisateur malveillant tente de récupérer le post d'un autre en devinant l'ID.
*   **Mitigation:**
    *   Les posts "pending" ne doivent **JAMAIS** être retournés par une requête `SELECT` publique.
    *   La récupération du post ne se fait qu'après validation du Magic Link, où le backend associe le `user_id` authentifié au post (basé sur l'email vérifié).

## 2. Analyse UX (Usability NFRs)

### 2.1. Perte de Contexte
*   **Risque:** L'utilisateur clique sur le lien magique dans un autre navigateur (ex: mail sur mobile, quiz fait sur desktop) et perd le fil.
*   **Mitigation:**
    *   Le lien magique doit rediriger vers une page "loading" qui interroge l'API pour récupérer le post associé à l'email *maintenant vérifié*.
    *   Le flux doit être agnostique du device.

### 2.2. Back Button Confusion
*   **Risque:** L'utilisateur fait "Précédent" après avoir reçu le mail et retombe sur le formulaire, créant un doublon ou une erreur.
*   **Mitigation:**
    *   Utiliser `router.replace()` au lieu de `push()` lors de la transition vers la vue "Check your email".
    *   Désactiver le bouton "Back" via `history.pushState` (soft lock).

## 3. Plan de Test Recommandé

1.  **Unit Test API:** Tester `pre-persist` avec des données valides et invalides.
2.  **Security Test:** Tenter d'insérer directement dans `posts` depuis le client (doit échouer).
3.  **E2E Test:**
    *   Parcours complet : Quiz -> Email -> DB check (pending) -> Magic Link -> DB check (revealed/linked) -> UI Reveal.
    *   Cross-device simulation (si possible, sinon tester auth sur un nouveau contexte).

## 4. Conclusion
Le design technique proposé est robuste *à condition* que l'écriture en DB soit strictement server-side. La migration DB est validée sous cette contrainte.
