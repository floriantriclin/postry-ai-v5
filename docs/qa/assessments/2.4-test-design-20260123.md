# Design de Test - Story 2.4 : Flux de Révélation

**Date :** 2026-01-23
**Auteur :** QA Lead
**Story :** [Story 2.4 - Flux de Révélation](../stories/story-2-4-reveal-flow.md)
**Risques Associés :** [Evaluation des Risques 2.4](2.4-risk-20260123.md)

## 1. Stratégie de Test

La stratégie repose sur trois piliers pour garantir la robustesse du flux critique de conversion :
1.  **Tests API (Vitest)** : Validation unitaire de l'endpoint `/api/quiz/pre-persist` pour sécuriser l'entrée des données.
2.  **Tests E2E (Playwright)** : Simulation du parcours utilisateur complet pour valider l'intégration Front/Back/Auth.
3.  **Vérification Manuelle (Exploratoire)** : Focus sur l'UX mobile, le verrouillage de la navigation et le flux cross-device.

## 2. Cas de Test Détaillés

### 2.1. Tests API (Backend)
*Cible : `app/api/quiz/pre-persist/route.ts`*

| ID | Cas de Test | Pré-conditions | Étapes | Résultat Attendu |
| :--- | :--- | :--- | :--- | :--- |
| **API-2.4-01** | **Création Post Pending (Succès)** | DB accessible | POST valide avec `email`, `vector`, `profile`, `theme`, `post`. | 200 OK. Entrée créée dans `posts` avec status='pending' et user_id=null. |
| **API-2.4-02** | **Validation Schéma (Erreur)** | - | POST avec champs manquants ou email invalide. | 400 Bad Request (Zod Error). Aucune entrée DB. |
| **API-2.4-03** | **Gestion des Doublons (Idempotence)** | Post 'pending' existe déjà pour cet email | POST identique (même email). | 200 OK (Mise à jour ou Ignore, ne doit pas planter). |
| **API-2.4-04** | **Rate Limiting (Sécurité)** | - | Envoi rapide de 20 requêtes depuis la même IP. | 429 Too Many Requests après N essais. |

### 2.2. Tests E2E (Frontend Integration)
*Cible : `e2e/quiz-reveal.spec.ts` (Nouveau fichier)*

| ID | Cas de Test | Description | Critères de Succès |
| :--- | :--- | :--- | :--- |
| **E2E-2.4-01** | **Happy Path : Conversion Complète** | Générer un quiz -> Remplir Formulaire Auth -> Clic "Révéler" -> (Simuler clic Magic Link) -> Voir Post Révélé. | - Appel `/pre-persist` intercepté (200 OK).<br>- Redirection vers page finale.<br>- Post affiché sans flou. |
| **E2E-2.4-02** | **Lock Navigation** | Sur l'écran d'attente Magic Link, tenter de cliquer sur "Précédent". | L'utilisateur reste sur la page d'attente (ou modal de confirmation). Pas de retour au quiz. |
| **E2E-2.4-03** | **Gestion Erreur Pre-Persist** | Mocker `/pre-persist` pour retourner 500. | Message d'erreur clair affiché à l'utilisateur ("Erreur de sauvegarde, réessayez"). |

### 2.3. Tests Manuels & Exploratoires

*   **Cross-Device Flow :**
    1.  Utilisateur A génère un post sur son iPhone (Safari).
    2.  Entre son email `test+qa@example.com`.
    3.  Reçoit le mail sur son Laptop.
    4.  Clique sur le lien depuis le Laptop.
    5.  **Attendu :** Le post s'affiche sur le Laptop, connecté.

*   **Comportement "Back" :**
    *   Tester sur Android (Chrome) : Le bouton physique "Retour" ne doit pas casser l'état de l'application.

## 3. Données de Test

*   **Emails de Test :** Utiliser des alias (ex: `qa+reveal01@postry.ai`) pour isoler les tests.
*   **Payload Type :**
    ```json
    {
      "email": "qa@test.com",
      "stylistic_vector": { "humour": 0.8 },
      "profile": { "job": "Dev" },
      "theme": "modern",
      "post_content": "Ceci est un test..."
    }
    ```

## 4. Plan d'Exécution

1.  **Pré-requis :** Migration DB appliquée en environnement de test.
2.  **Ordre :**
    1.  Tests API (pour valider le backend).
    2.  Tests E2E (pour valider le flux).
    3.  Tests Manuels (pour valider l'expérience).
