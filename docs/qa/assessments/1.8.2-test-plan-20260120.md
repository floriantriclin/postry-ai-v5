# Plan de Test pour la Story 1.8.2 : Orchestration Phase 2 & Profil Augmenté

Ce document détaille la stratégie de test pour valider les fonctionnalités introduites par la story 1.8.2, en se concentrant sur le pré-chargement, le calcul local et la génération du profil final.

## 1. Objectifs de Test

-   **Valider la logique de calcul client :** S'assurer que le vecteur de style est correctement mis à jour localement à chaque réponse.
-   **Confirmer l'efficacité du prefetching :** Vérifier que le pré-chargement des questions de la phase 2 améliore la fluidité perçue et que les cas de latence sont correctement gérés.
-   **Garantir l'exactitude du profil final :** S'assurer que le profil augmenté est généré avec le vecteur final correct via `/profile`.
-   **Vérifier la gestion des états de chargement :** Confirmer que des indicateurs visuels clairs sont présentés à l'utilisateur pendant le pré-chargement et la génération du profil final.

## 2. Périmètre de Test

### Fonctionnalités à Tester

-   (AC 1.1) Lancement de l'appel de pré-chargement `POST /api/quiz/generate?phase=2` à l'affichage de l'interstitiel.
-   (AC 1.2) Mise à jour correcte du vecteur local (via `ice-logic`) pour les questions 7 à 11.
-   (AC 1.2) Transition immédiate de l'UI vers la question suivante (zéro latence réseau).
-   (AC 1.3) Affichage d'un indicateur de chargement si la phase 2 est démarrée avant la fin du pré-chargement.
-   (AC 2.1) Déclenchement de l'appel `POST /api/quiz/profile` avec le vecteur final correct.
-   (AC 2.2) Mise à jour de l'état client avec les données du profil (`label_final`, `definition_longue`).
-   (AC 2.2) Passage de la barre de progression "Précision" de 50% à 100%.
-   (AC 2.3) Affichage d'un état de chargement spécifique pendant l'appel à `/profile`.

### Fonctionnalités Hors Périmètre

-   Tests de performance exhaustifs des endpoints (couverts par des tests spécifiques).
-   Validation de la logique métier interne des endpoints `/refine` et `/profile` (couverts par les tests unitaires de l'API).

## 3. Stratégie de Test

Une approche multi-niveaux sera utilisée pour couvrir tous les aspects de la story.

### A. Tests d'Intégration (Niveau API - `vitest`)

Ces tests sont cruciaux pour valider la logique d'orchestration backend et les race conditions potentielles, sans la complexité de l'UI.

| ID Test | Description | Prérequis | Étapes de Test | Assertions Attendues |
|---|---|---|---|---|
| **INT-1.8.2-01** | **Flux nominal de la Phase 2 (API)** | Un `baseArchetype` et un vecteur simulé V11. | 1. `POST /generate?phase=2` (pour valider le prefetch payload). <br> 2. `POST /profile` avec un vecteur complet V11. | - `/generate` retourne les questions 7-11. <br> - `/profile` retourne un statut 200, `label_final` et `definition_longue`. |
| **UNIT-1.8.2-02** | **Logique Vectorielle Client** | Librairie `ice-logic`. | 1. Appeler `updateVector` avec une réponse et une cible. | - Le nouveau vecteur est mathématiquement correct (approche de 30% vers la cible). |

### B. Tests End-to-End (Niveau UI - `playwright`)

Ces tests simulent le parcours utilisateur complet pour valider l'intégration front-end et l'expérience utilisateur "Zéro Latence".

| ID Test | Description | Prérequis | Étapes de Test | Assertions Attendues |
|---|---|---|---|---|
| **E2E-1.8.2-01** | **Parcours Phase 2 & Zéro Latence** | Quiz en cours, à l'écran interstitiel post-Q6. | 1. Atteindre l'interstitiel -> vérifier `POST /generate?phase=2`. <br> 2. Démarrer Phase 2. <br> 3. Répondre Q7-11. <br> 4. **Vérifier l'ABSENCE d'appels `/refine`**. <br> 5. Vérifier l'appel unique `/profile` à la fin. | - Fluidité totale entre les questions (pas de spinner). <br> - `label_final` affiché à la fin. <br> - Précision passe à 100%. |
| **E2E-1.8.2-02** | **Gestion du pré-chargement lent (Loader)** | Quiz en cours, à l'écran interstitiel. | 1. Intercepter `/generate?phase=2` avec délai 5s. <br> 2. Cliquer "Continuer" immédiatement. | - Bouton en état loading / Loader visible. <br> - Pas de transition Q7 tant que loading. <br> - Transition auto Q7 à la fin du délai. |

## 4. Environnement de Test & Données

-   **Navigateur :** Chrome (via Playwright).
-   **Environnement :** Environnement de développement local (`npm run dev`).
-   **Données :** Les mocks de questions et de réponses seront utilisés par l'API pour assurer la cohérence et la reproductibilité des tests.

## 5. Livrables

-   Code des tests d'intégration ajouté au fichier `app/api/quiz/logic.test.ts`.
-   Nouveau fichier de test E2E `e2e/quiz-phase-2.spec.ts`.
-   Rapport d'exécution des tests généré par Playwright et Vitest.
