<?xml version="1.0" encoding="UTF-8"?>
<protocol name="linear-integration" version="1.0">
  <metadata>
    <title>Protocole d'Int√©gration Linear</title>
    <description>Protocole r√©utilisable pour cr√©er et g√©rer des issues dans Linear</description>
    <author>BMAD System</author>
    <date>2026-01-27</date>
  </metadata>

  <critical>
    üéØ R√àGLE D'OR : Toujours v√©rifier si une issue existe AVANT d'en cr√©er une nouvelle
    üîÑ R√àGLE CRITIQUE : Linear ‚Üî Fichiers locaux doivent TOUJOURS √™tre synchronis√©s (voir .cursor/rules/linear-sync.md)
  </critical>

  <!-- ============================================ -->
  <!-- PROTOCOLE 1: Cr√©er une Issue dans Linear -->
  <!-- ============================================ -->
  <procedure name="create_linear_issue">
    <description>Cr√©e une issue dans Linear apr√®s v√©rification des doublons</description>
    
    <inputs>
      <input name="title" type="string" required="true" description="Titre de l'issue"/>
      <input name="description" type="string" required="true" description="Description Markdown"/>
      <input name="priority" type="string" required="false" description="critique|high|medium|low"/>
      <input name="estimate" type="number" required="false" description="Estimation en heures"/>
      <input name="labels" type="array" required="false" description="Liste de labels"/>
      <input name="assignee" type="string" required="false" description="Assign√© (me, email, name, ID)"/>
      <input name="project" type="string" required="false" description="Projet Linear"/>
    </inputs>

    <steps>
      <step n="1" title="Charger la configuration Linear">
        <action>Lire le fichier {project-root}/_bmad/_memory/linear-config.yaml</action>
        <action>Extraire default_team, priority_mapping, labels</action>
      </step>

      <step n="2" title="V√©rifier si l'issue existe d√©j√†">
        <action>Appeler l'outil MCP: list_issues avec query={title_keywords}</action>
        <check if="issue existe d√©j√† avec titre similaire">
          <output>‚ö†Ô∏è Issue d√©j√† existante trouv√©e: {issue_id} - {issue_title}</output>
          <output>URL: {issue_url}</output>
          <ask>Voulez-vous : [u]pdater l'issue existante, [c]r√©er quand m√™me, ou [s]kip?</ask>
          <check if="r√©ponse = 'u'">
            <action>GOTO step 4 (update issue)</action>
          </check>
          <check if="r√©ponse = 's'">
            <action>RETURN {issue_id, issue_url, action: 'skipped'}</action>
          </check>
        </check>
      </step>

      <step n="3" title="Mapper les priorit√©s et labels">
        <action>Convertir {priority} selon priority_mapping (critique‚Üí1, high‚Üí2, etc.)</action>
        <action>Valider que les {labels} existent dans la config</action>
        <action>Pr√©parer les param√®tres pour l'API Linear</action>
      </step>

      <step n="4" title="Cr√©er l'issue dans Linear">
        <action>Appeler l'outil MCP: create_issue avec:</action>
        <parameters>
          - title: {title}
          - description: {description}
          - team: {default_team}
          - priority: {mapped_priority}
          - estimate: {estimate}
          - labels: {labels}
          - assignee: {assignee}
          - project: {project}
        </parameters>
        <action>R√©cup√©rer: issue_id, identifier, url, gitBranchName</action>
      </step>

      <step n="5" title="Enregistrer la r√©f√©rence">
        <action>Optionnel: Cr√©er un lien dans la doc locale</action>
        <action>Optionnel: Ajouter l'URL Linear dans les fichiers concern√©s</action>
        <output>‚úÖ Issue cr√©√©e avec succ√®s!</output>
        <output>ID: {identifier} ({issue_id})</output>
        <output>URL: {url}</output>
        <output>Git Branch: {gitBranchName}</output>
      </step>

      <step n="5b" title="V√©rifier Synchronisation Linear ‚Üî Local" critical="true">
        <check if="fichier local existe (_bmad-output/implementation-artifacts/*.md)">
          <action>V√©rifier coh√©rence entre issue Linear et fichier local</action>
          <check if="divergence d√©tect√©e">
            <action>Informer utilisateur des diff√©rences</action>
            <ask>Mettre √† jour Linear ou fichier local ? [Linear/Local/Skip]</ask>
            <action>Proc√©der √† la synchronisation selon choix utilisateur</action>
          </check>
        </check>
        <note>Voir r√®gle compl√®te: .cursor/rules/linear-sync.md</note>
      </step>

      <step n="6" title="Retourner les informations">
        <return>
          {
            "issue_id": "{issue_id}",
            "identifier": "{identifier}",
            "url": "{url}",
            "gitBranchName": "{gitBranchName}",
            "action": "created"
          }
        </return>
      </step>
    </steps>
  </procedure>

  <!-- ============================================ -->
  <!-- PROTOCOLE 2: Mettre √† Jour une Issue Linear -->
  <!-- ============================================ -->
  <procedure name="update_linear_issue">
    <description>Met √† jour une issue Linear existante</description>
    
    <inputs>
      <input name="issue_id_or_identifier" type="string" required="true" description="ID ou Identifier (ex: BMA-5)"/>
      <input name="status" type="string" required="false" description="Nouveau statut"/>
      <input name="description" type="string" required="false" description="Nouvelle description"/>
      <input name="priority" type="number" required="false" description="Nouvelle priorit√©"/>
    </inputs>

    <steps>
      <step n="1" title="R√©cup√©rer l'issue existante">
        <action>Appeler l'outil MCP: get_issue avec id={issue_id_or_identifier}</action>
        <action>Valider que l'issue existe</action>
      </step>

      <step n="2" title="Appliquer les modifications">
        <action>Appeler l'outil MCP: update_issue avec les nouveaux champs</action>
        <output>‚úÖ Issue {identifier} mise √† jour</output>
      </step>
    </steps>
  </procedure>

  <!-- ============================================ -->
  <!-- PROTOCOLE 3: Lister les Issues pour Contexte -->
  <!-- ============================================ -->
  <procedure name="get_linear_context">
    <description>R√©cup√®re le contexte Linear (bugs, stories, etc.)</description>
    
    <inputs>
      <input name="filter_type" type="string" required="false" description="bug|feature|story"/>
      <input name="filter_status" type="string" required="false" description="backlog|in-progress|done"/>
    </inputs>

    <steps>
      <step n="1" title="R√©cup√©rer les issues">
        <action>Appeler l'outil MCP: list_issues avec filtres</action>
        <action>Parser et formater les r√©sultats</action>
      </step>

      <step n="2" title="Retourner le contexte">
        <return>Liste format√©e des issues avec ID, titre, statut, priorit√©, URL</return>
      </step>
    </steps>
  </procedure>

  <!-- ============================================ -->
  <!-- USAGE DANS LES WORKFLOWS -->
  <!-- ============================================ -->
  <usage>
    <example>
      <!-- Dans un workflow XML, utiliser: -->
      <invoke-protocol name="linear-integration.create_linear_issue">
        <param name="title">üêõ Bug trouv√© dans le Dashboard</param>
        <param name="description">## Description\n\nLe dashboard crash...</param>
        <param name="priority">critique</param>
        <param name="estimate">2</param>
        <param name="labels">["Bug"]</param>
      </invoke-protocol>
    </example>
  </usage>

  <notes>
    <note>Ce protocole n√©cessite que le MCP server Linear soit configur√©</note>
    <note>La configuration Linear doit √™tre dans _bmad/_memory/linear-config.yaml</note>
    <note>Toujours v√©rifier les doublons avant de cr√©er une nouvelle issue</note>
  </notes>
</protocol>
