# Risk Profile: Story 1.7 - API de Synthèse du Profil Augmenté

Date: 2026-01-20
Reviewer: Quinn (Test Architect)

## Executive Summary

- **Total Risks Identified**: 6
- **Critical Risks**: 0
- **High Risks**: 0
- **Medium Risks**: 3
- **Overall Risk Score**: 79/100 (Moderate Risk)

The implementation of the Profile Synthesis API involves standard LLM integration risks. The primary concerns are related to the stability of the LLM output (formatting and word counts) and the end-to-end latency, which is critical for user conversion at the end of the quiz tunnel.

## Risk Distribution

### By Category
- **Technical**: 1 risk (Medium)
- **Performance**: 1 risk (Medium)
- **Data**: 1 risk (Low)
- **Business**: 1 risk (Medium)
- **Operational**: 1 risk (Low)
- **Security**: 1 risk (Low)

### By Component
- **Backend (API)**: 4 risks
- **External (LLM)**: 2 risks

## Detailed Risk Register

| Risk ID | Description | Category | Probability | Impact | Score | Priority |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **TECH-001** | **LLM Formatting/Constraint Violation**: Gemini fails to return valid JSON or respect the 45-75 words constraint. | TECH | Medium (2) | Medium (2) | 4 | Medium |
| **PERF-001** | **Latency Bottleneck**: LLM generation exceeds 12s (target < 10s), causing user drop-off. | PERF | Medium (2) | Medium (2) | 4 | Medium |
| **BUS-001** | **Content Irrelevance**: The synthesized profile feels generic or disconnected from the input vector. | BUS | Medium (2) | Medium (2) | 4 | Medium |
| **OPS-001** | **Gemini API Availability**: Google AI service downtime prevents quiz completion. | OPS | Low (1) | High (3) | 3 | Low |
| **DATA-001** | **Zod Validation Failure**: Input vector or archetype is malformed. | DATA | Low (1) | Medium (2) | 2 | Low |
| **DATA-002** | **Drift Calculation Error**: Incorrect identification of the "Drift Hint" leads to misleading profile synthesis. | DATA | Medium (2) | Low (1) | 2 | Low |
| **SEC-001** | **Quota/API Key Abuse**: Unexpected costs or key leakage. | SEC | Low (1) | Medium (2) | 2 | Low |

## Mitigation Strategies & Testing Focus

### TECH-001: LLM Formatting
- **Mitigation**: 
    - Use `cleanJsonResponse` utility.
    - Strict Zod schema validation on LLM output.
    - Implementation of a retry strategy (max 3 attempts).
- **Testing Focus**: 
    - Unit tests for JSON extraction.
    - Integration tests mocking "dirty" JSON responses.
    - Validation of word count logic in tests.

### PERF-001: Latency
- **Mitigation**: 
    - Selection of `gemini-2.5-flash` for speed.
    - 12s timeout configuration.
- **Testing Focus**: 
    - Performance tests measuring end-to-end response time.
    - Simulation of Gemini API latency spikes.

### BUS-001: Content Quality
- **Mitigation**:
    - Use of the "Super-Prompt" defined in ICE Protocol.
    - Contextual injection of the Archetype name.
    - Integration of "Drift Hint" to anchor synthesis in actual user variation.
- **Testing Focus**:
    - Manual "Golden Set" review of generated profiles for distinct archetypes.
    - Specific verification of "Extreme Vectors" (<15 or >85) prominence in the output.

## Risk-Based Testing Strategy

### Priority 1: Resilience Tests
- Validate the retry logic when Gemini returns invalid JSON.
- Validate error handling (502) when all retries fail.

### Priority 2: Performance & Timeouts
- Ensure the API handles Gemini timeouts gracefully.
- Verify that the total response time stays within acceptable bounds for the frontend.

### Priority 3: Data Integrity
- Ensure the input vector ($V_{11}$) is correctly mapped to the JSON object expected by the prompt.

## Risk Acceptance Criteria

### Must Fix Before Production
- Reliable Zod validation of LLM output.
- Functional retry mechanism for transient LLM errors.
- Correlation ID tracking for debugging LLM failures.
- Accurate "Drift Hint" calculation logic.

### Can Deploy with Mitigation
- Minor word count deviations (e.g., 40 or 80 words instead of exactly 45-75) if the quality is high.
- Occasional latency peaks near 12s as long as the average is < 10s.

## Monitoring Requirements
- Log LLM response times.
- Track Zod validation failure rates in LLM outputs.
- Monitor Gemini API quota usage.
