# Risk Profile: Story 2.2 - Authentification par Magic Link

**Date:** 2026-01-22
**Version:** 1.0

## 1. Vue d'ensemble des Risques

Cette story introduit le mécanisme principal d'entrée pour les utilisateurs. Un échec ici bloque complètement l'acquisition (SignUp) et la rétention (SignIn). Le niveau de risque est **CRITIQUE**.

| ID | Risque | Impact | Probabilité | Sévérité | Stratégie d'Atténuation |
|:---|:---|:---|:---|:---|:---|
| R-2.2-01 | **Échec de livraison d'email** (Spam, délai, erreur provider) | Bloquant | Moyenne | Haute | Feedback UI clair après l'envoi ("Vérifiez vos spams"). Gestion d'erreur Supabase explicite. |
| R-2.2-02 | **Mauvaise configuration `NEXT_PUBLIC_BASE_URL`** | Liens magiques cassés ou redirection vers localhost en prod | Faible | Critique | Vérification au build/déploiement. Smoke test post-déploiement. |
| R-2.2-03 | **Rate Limiting Supabase** (30/heure par défaut) | Frustration utilisateur (blocage temporaire) | Moyenne | Moyenne | Catcher l'erreur 429/RateLimit et afficher un message convivial ("Trop de tentatives, réessayez dans 1h"). |
| R-2.2-04 | **Redirection incorrecte (Callback)** | Utilisateur perdu après clic (ne voit pas son résultat) | Faible | Haute | Tests manuels avec différents params `redirectTo`. Validation du paramètre `next` dans la route callback. |
| R-2.2-05 | **Sécurité PKCE (Code Exchange)** | Vol de session potentiel | Très Faible | Critique | Utilisation stricte des helpers SSR de Supabase (`createServerClient`) qui gèrent PKCE automatiquement. |

## 2. Focus Qualité

### Sécurité
- Validation stricte de l'email (Zod) avant l'appel Supabase pour économiser des quotas et éviter des injections basiques.
- Vérification que la redirection ne permet pas l'Open Redirect (limité au domaine de l'app via config Supabase).

### Usabilité (UX)
- Le message de succès doit être immédiat et clair.
- L'état de chargement pendant l'envoi du lien est crucial.

### Fiabilité
- La route de callback doit être résiliente (gérer le cas où le code est invalide ou expiré).
