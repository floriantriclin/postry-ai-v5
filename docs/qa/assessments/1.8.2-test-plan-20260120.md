# Plan de Test pour la Story 1.8.2 : Orchestration Phase 2 & Profil Augmenté

Ce document détaille la stratégie de test pour valider les fonctionnalités introduites par la story 1.8.2, en se concentrant sur le pré-chargement, les appels asynchrones et la génération du profil final.

## 1. Objectifs de Test

-   **Valider la robustesse du flux asynchrone :** S'assurer que les appels "fire-and-forget" à `/refine` ne compromettent ni l'expérience utilisateur ni l'intégrité du profil final.
-   **Confirmer l'efficacité du prefetching :** Vérifier que le pré-chargement des questions de la phase 2 améliore la fluidité perçue et que les cas de latence sont correctement gérés.
-   **Garantir l'exactitude du profil final :** S'assurer que le profil augmenté est calculé sur la base de toutes les réponses de l'utilisateur et affiché correctement.
-   **Vérifier la gestion des états de chargement :** Confirmer que des indicateurs visuels clairs sont présentés à l'utilisateur pendant le pré-chargement et la génération du profil final.

## 2. Périmètre de Test

### Fonctionnalités à Tester

-   (AC 1.1) Lancement de l'appel de pré-chargement `POST /api/quiz/generate?phase=2` à l'affichage de l'interstitiel.
-   (AC 1.2) Envoi asynchrone des appels `POST /api/quiz/refine` pour les questions 7 à 11.
-   (AC 1.2) Transition immédiate de l'UI vers la question suivante sans attendre la réponse de `/refine`.
-   (AC 1.3) Affichage d'un indicateur de chargement si la phase 2 est démarrée avant la fin du pré-chargement.
-   (AC 2.1) Déclenchement de l'appel `POST /api/quiz/profile` après le dernier `/refine`.
-   (AC 2.2) Mise à jour de l'état client avec les données du profil (`label_final`, `definition_longue`).
-   (AC 2.2) Passage de la barre de progression "Précision" de 50% à 100%.
-   (AC 2.3) Affichage d'un état de chargement spécifique pendant l'appel à `/profile`.

### Fonctionnalités Hors Périmètre

-   Tests de performance exhaustifs des endpoints (couverts par des tests spécifiques).
-   Validation de la logique métier interne des endpoints `/refine` et `/profile` (couverts par les tests unitaires de l'API).

## 3. Stratégie de Test

Une approche multi-niveaux sera utilisée pour couvrir tous les aspects de la story.

### A. Tests d'Intégration (Niveau API - `vitest`)

Ces tests sont cruciaux pour valider la logique d'orchestration backend et les race conditions potentielles, sans la complexité de l'UI.

| ID Test | Description | Prérequis | Étapes de Test | Assertions Attendues |
|---|---|---|---|---|
| **INT-1.8.2-01** | **Flux nominal de la Phase 2** | Un `quizId` valide de la phase 1. | 1. `POST /generate?phase=2`. <br> 2. Boucle `POST /refine` pour Q7-10. <br> 3. `POST /refine` pour Q11. <br> 4. `POST /profile`. | - `/profile` retourne un statut 200. <br> - La réponse contient `label_final` et `definition_longue`. |
| **INT-1.8.2-02** | **Gestion de la concurrence `/refine` et `/profile`** | Un `quizId` valide. | 1. Simuler les appels `refine` pour Q7-11. <br> 2. Introduire un délai sur la résolution du dernier appel `refine`. <br> 3. Appeler `/profile` immédiatement après. | - `/profile` doit attendre la fin du traitement de tous les `/refine` et retourner le profil complet. |

### B. Tests End-to-End (Niveau UI - `playwright`)

Ces tests simulent le parcours utilisateur complet pour valider l'intégration front-end et l'expérience utilisateur.

| ID Test | Description | Prérequis | Étapes de Test | Assertions Attendues |
|---|---|---|---|---|
| **E2E-1.8.2-01** | **Parcours utilisateur complet - Scénario nominal** | Quiz en cours, à l'écran interstitiel post-Q6. | 1. Atteindre l'interstitiel. <br> 2. Vérifier (via interception réseau) que `generate?phase=2` est appelé. <br> 3. Démarrer la phase 2. <br> 4. Répondre à Q7-11. <br> 5. Vérifier les appels `refine`. <br> 6. Vérifier l'appel `profile` et l'écran de chargement. <br> 7. Attendre le résultat final. | - Le `label_final` est affiché. <br> - La barre de précision est à 100%. <br> - Le flux est fluide et sans erreur visible. |
| **E2E-1.8.2-02** | **Gestion du pré-chargement lent** | Quiz en cours, à l'écran interstitiel. | 1. Intercepter `/generate?phase=2` et ajouter un délai de 3s. <br> 2. Cliquer pour démarrer la phase 2. <br> 3. Attendre la résolution de l'appel. | - Un indicateur de chargement est visible. <br> - La Q7 s'affiche une fois les données reçues. |
| **E2E-1.8.2-03** | **Robustesse face à un échec de `/refine`** | Quiz en cours, phase 2 démarrée. | 1. Intercepter et simuler une erreur 500 sur l'appel `/refine` de la Q8. <br> 2. Répondre à la Q8. | - L'UI passe immédiatement à la Q9 sans message d'erreur bloquant. |

## 4. Environnement de Test & Données

-   **Navigateur :** Chrome (via Playwright).
-   **Environnement :** Environnement de développement local (`npm run dev`).
-   **Données :** Les mocks de questions et de réponses seront utilisés par l'API pour assurer la cohérence et la reproductibilité des tests.

## 5. Livrables

-   Code des tests d'intégration ajouté au fichier `app/api/quiz/logic.test.ts`.
-   Nouveau fichier de test E2E `e2e/quiz-phase-2.spec.ts`.
-   Rapport d'exécution des tests généré par Playwright et Vitest.
