# Design de Test - Story 2.3 : Modal de Capture & Déclenchement Auth

**Objectif :** Valider le composant de capture d'email (`AuthModal` / `ConversionOverlay`) et son intégration dans le flux d'authentification par Magic Link, en mettant l'accent sur les états UI, la validation, et les NFR (Accessibilité, Mobile).

## Stratégie de Test

| Type | Outil | Couverture | Notes |
| :--- | :--- | :--- | :--- |
| **Tests de Composant** | [Vitest](docs/qa/syntax/vitest.md) / [RTL](docs/qa/syntax/react-testing-library.md) | Logique UI, Validation API (mockée), Gestion des États (Loading, Success, Error), Accessibilité (Focus Trap, Rôles ARIA). | Testez le composant de manière isolée, en mockant la fonction d'appel API. |
| **Tests End-to-End** | [Playwright](docs/qa/syntax/playwright.md) | Intégration dans le flux complet (Quiz -> Post Flouté -> Modal), Happy Path de conversion, Responsivité Mobile, Non-fermeture. | Utilisez un viewport mobile pour le test de responsivité. |

## Statut (2026-01-23)

**VALIDATED**

Tous les cas de test de composant et End-to-End ont été exécutés avec succès. La story 2.3 est considérée comme validée du point de vue QA.

## Cas de Test Détaillés

### 1. Tests de Composant (`AuthModal.test.tsx`)

**Cible :** `AuthModal.tsx` ou `ConversionOverlay.tsx`

| ID | Objectif du Test | Étapes de Vérification | Critères de Succès | Statut | Type | Risques Couverts |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| C2.3.1 | **Affichage Initial** | Rendre le composant. | L'input Email et le bouton CTA sont visibles. Les messages de succès et d'erreur sont masqués. | ✅ Succès | Fonctionnel | R2.3.5 |
| C2.3.2 | **Validation API (Email Invalide)** | 1. Saisir un email invalide (ex: `test@test`). 2. Soumettre le formulaire. 3. Mocker une réponse API d'erreur de validation. | L'appel à `signInWithEmail()` est effectué. Un message d'erreur provenant de l'API est affiché. Le bouton est de nouveau actif. | ✅ Succès | Négatif/API | R2.3.2 |
| C2.3.4 | **État de Chargement (`soumission`)** | 1. Saisir un email valide. 2. Cliquer sur soumettre et simuler une réponse API en attente. | Le bouton de soumission est désactivé. Un indicateur de chargement visuel est affiché. | ✅ Succès | Fonctionnel | R2.3.5 |
| C2.3.5 | **État de Succès** | 1. Saisir un email valide. 2. Cliquer sur soumettre et mocker une réponse API réussie. | Le message "Lien de connexion envoyé. Vérifiez votre boîte mail." est affiché. La modal ne se ferme pas. | ✅ Succès | Fonctionnel | R2.3.1, R2.3.5 |
| C2.3.6 | **État d'Erreur API** | 1. Saisir un email valide. 2. Cliquer sur soumettre et mocker une réponse API échouée. | Un message d'erreur d'API est affiché. Le bouton redevient actif. | ✅ Succès | Négatif | R2.3.1, R2.3.5 |
| C2.3.7 | **Accessibilité (Rôles ARIA)** | Vérifier la structure DOM du composant rendu. | Le composant principal de la modal possède l'attribut `role="dialog"`. | ✅ Succès | NFR/A11Y | R2.3.3 |
| C2.3.8 | **Accessibilité (Focus Trap)** | Tenter de tabuler au-delà des limites de la modal. | Le focus reste piégé entre l'input et le bouton de soumission. | ✅ Succès | NFR/A11Y | R2.3.3 |
| C2.3.9 | **Non-Fermeture de la Modal** | 1. Rendre le composant. 2. Simuler une pression sur la touche `Echap`. | La modal reste visible et aucun `onClose` (s'il existait) n'est appelé. Il n'y a pas de bouton de fermeture. | ✅ Succès | Négatif/UX | R2.3.8 |
| C2.3.10 | **Accessibilité (Erreur Vocale)** | 1. Suivre les étapes du test C2.3.6 (État d'Erreur API). 2. Vérifier les attributs du message d'erreur. | Le paragraphe contenant le message d'erreur possède l'attribut `role="alert"`. | ✅ Succès | NFR/A11Y | R2.3.3 |

### 2. Tests End-to-End (`e2e/auth-modal.spec.ts`)

**Cible :** Parcours utilisateur complet sur Playwright.

| ID | Objectif du Test | Étapes de Vérification | Critères de Succès | Statut | Type | Risques Couverts |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| E2.3.1 | **Parcours Critique (Happy Path)** | 1. Compléter le Quiz jusqu'à la page du Post Flouté. 2. Saisir un email valide (utilisant un email jetable mocké si possible). 3. Soumettre le formulaire. | Le modal est immédiatement visible à l'arrivée sur la page (R2.3.6). L'appel API est intercepté/vérifié. Le message de succès est affiché. | ✅ Succès | Fonctionnel/Flow | R2.3.1, R2.3.6 |
| E2.3.2 | **Test de Responsivité Mobile** | 1. Configurer Playwright avec un viewport mobile (ex: `iphone-x`). 2. Exécuter l'étape E2.3.1 (ou simplement charger la modal). | L'UI est correctement agencée sans débordement horizontal. Les zones de clic (input/CTA) sont facilement utilisables. | ✅ Succès | NFR/UX | R2.3.4 |
| E2.3.3 | **Vérification de la Validation API** | 1. Naviguer jusqu'à la modal. 2. Tenter de soumettre avec un email invalide. 3. Intercepter et vérifier la réponse de l'API. | L'appel API est effectué. Le message d'erreur correspondant à la réponse de l'API est affiché. | ✅ Succès | Négatif/Flow | R2.3.2 |
| E2.3.4 | **Vérification de Non-Fermeture** | 1. Naviguer jusqu'à la modal. 2. Appuyer sur la touche `Escape` du clavier. | La modal reste visible. | ✅ Succès | Négatif/Flow | R2.3.8 |
