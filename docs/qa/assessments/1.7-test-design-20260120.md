# Test Design: Story 1.7 - API de Synthèse du Profil Augmenté

Date: 2026-01-20
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total Test Scenarios**: 11
- **Unit Tests**: 4 (36%)
- **Integration Tests**: 7 (64%)
- **Priority Distribution**:
    - **P0 (Critical)**: 6
    - **P1 (High)**: 4
    - **P2 (Medium)**: 1

The strategy emphasizes integration testing due to the heavy dependency on the external Gemini API and the complexity of the "Prompt + LLM + Parsing" pipeline. Unit tests focus on data validation and prompt mapping.

## Test Scenarios by Acceptance Criteria

### AC1: Endpoint et Validation

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| **1.7-UNIT-001** | Unit | P0 | Validate `finalVector` schema | Ensures data integrity of the style vector ($V_{11}$). |
| **1.7-UNIT-002** | Unit | P1 | Validate `baseArchetype` format | Prevents injection of invalid archetype labels. |
| **1.7-INT-001** | Integration | P0 | `POST /api/quiz/profile` returns 400 on malformed payload | Validates API boundary and Zod integration. |

### AC2: Logique de Synthèse avec Gemini

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| **1.7-UNIT-003** | Unit | P1 | Prompt mapping validation | Ensures the style vector is correctly stringified for the LLM. |
| **1.7-UNIT-004** | Unit | P0 | Drift Hint calculation | Verifies the logic identifying the largest deviation from base archetype. |
| **1.7-INT-002** | Integration | P0 | Successful synthesis (Nominal Flow) | Verifies the end-to-end integration with mock Gemini. |
| **1.7-INT-003** | Integration | P0 | Retry strategy on invalid JSON | Mitigates **TECH-001**: Ensures resilience against transient LLM errors. |
| **1.7-INT-004** | Integration | P2 | Word count validation handling | Validates that non-compliant LLM output (outside 45-75 words) is caught. |
| **1.7-INT-005** | Integration | P1 | 502 Error on LLM exhaustion | Ensures clean failure after all retries fail. |
| **1.7-INT-008** | Integration | P1 | Extreme Vectors (<15 or >85) | Verifies that extreme values are appropriately reflected in synthesis. |

### AC3 & AC4: Qualité, Performance & Observabilité

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| **1.7-INT-006** | Integration | P0 | API Latency < 12s | Mitigates **PERF-001**: Critical for user conversion at quiz end. |
| **1.7-INT-007** | Integration | P1 | Correlation ID Propagation | Ensures observability for debugging production issues. |

## Risk Coverage

- **TECH-001 (LLM Formatting)**: Fully covered by 1.7-INT-003, 1.7-INT-004, 1.7-INT-005.
- **PERF-001 (Latency)**: Covered by 1.7-INT-006 (Target < 10s, Limit 12s).
- **BUS-001 (Quality)**: Covered by 1.7-INT-002, 1.7-INT-008.
- **DATA-001 (Validation)**: Covered by 1.7-UNIT-001, 1.7-INT-001.
- **DATA-002 (Drift Hint)**: Covered by 1.7-UNIT-004.

## Recommended Execution Order

1. **Unit Tests (1.7-UNIT-*)**: Run first to ensure base logic is sound.
2. **Nominal Integration Test (1.7-INT-002)**: Verify the happy path.
3. **Resilience Tests (1.7-INT-003, 005)**: Verify error handling and retries.
4. **Performance & Observability (1.7-INT-006, 007)**: Verify non-functional requirements.

## Implementation Notes (QA)
- Use **Vitest** for integration tests with `vi.mock` for the Gemini client.
- Use **`scripts/test-gemini-real.ts`** for manual validation against the live API to calibrate prompts.
- Test data should include extreme vectors (all 0s, all 100s) to observe LLM behavior.
