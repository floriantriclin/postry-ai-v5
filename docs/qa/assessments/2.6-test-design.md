 # Test Design: Story 2.6 - Stabilization & Fiabilisation

**Parent Epic:** [Epic 2 : Conversion & Identit√©](../epics/epic-2-conversion.md)  
**Story:** [Story 2.6 : Stabilisation, Refactoring & Fiabilisation](../stories/story-2-6-stabilization-refactoring.md)  
**Date:** 24 Janvier 2026  
**Author:** QA Architect

---

## 1. Test Strategy

This story is unique as its primary output is **Quality Assurance itself**. The strategy focuses on refactoring the *tests* to be resilient, rather than just testing new features.

### Objectives
1.  **Eliminate Flakiness:** Reduce "False Negatives" in `dashboard.spec.ts` to 0%.
2.  **Guarantee Data Integrity:** Prove that no user data is left behind or corrupted during the Auth transition.
3.  **Sanitize UX:** Ensure navigation edge cases (Back button, Refresh) are handled elegantly.

### Scope
*   **In Scope:** `e2e/auth.setup.ts`, `e2e/dashboard.spec.ts`, Supabase Database (`public.posts`), Browser Navigation (History API).
*   **Out of Scope:** modifying the core Quiz Algorithm (Ice Core).

---

## 2. Automated Test Scenarios (Playwright)

These scenarios define the *new* behavior expected from the test infrastructure.

### Suite: Infrastructure & Setup (`e2e/auth.setup.ts`)

| ID | Scenario | Steps | Expected Result |
| :--- | :--- | :--- | :--- |
| **TS-AUTO-01** | **Smart Auth - Valid Session** | 1. `auth.setup.ts` runs.<br>2. Valid `user.json` exists.<br>3. Verify Session via Supabase Client. | Test reuses session, skips login UI. Output: "Session valid". |
| **TS-AUTO-02** | **Smart Auth - Expired/Invalid Session** | 1. `auth.setup.ts` runs.<br>2. `user.json` exists but token is invalid/expired.<br>3. Verify Session via Supabase Client. | Setup detects invalidity, performs fresh UI Login, overwrites `user.json`. |
| **TS-AUTO-03** | **Data Seeding - Missing Post** | 1. Authenticated User has NO posts in DB.<br>2. Run `dashboard.spec.ts` setup hook. | Script inserts a default Post via Admin API. Test proceeds without "Empty State" failure. |

### Suite: Dashboard Stability (`e2e/dashboard.spec.ts`)

| ID | Scenario | Steps | Expected Result |
| :--- | :--- | :--- | :--- |
| **TS-AUTO-04** | **Fail Fast on Redirection** | 1. Force logout or invalid token.<br>2. Navigate to `/dashboard`. | Test asserts URL is `/dashboard`. Fails *immediately* if redirected to `/` or `/login` (instead of timing out waiting for an element). |
| **TS-AUTO-05** | **Robust Locators** | 1. Load Dashboard.<br>2. Verify "Copy" button existence. | Use `getByTestId('copy-button')` instead of text/class selectors. |
| **TS-AUTO-06** | **Visual Regression (Update)** | 1. Load Dashboard with Seeded Data.<br>2. Wait for Reveal Animation. | Snapshot matches the "Brutalist" design (Story 2.5 spec) consistently. |

---

## 3. Manual & Exploratory Test Scenarios

These scenarios cover complex state transitions that are hard to automate or require "feel".

### Scenario: Data Persistence & Cleanup
**ID:** TS-MAN-01

1.  **Setup:** Open DevTools > Application > Local Storage. Clear all.
2.  **Action:** Complete Quiz. Note `quiz-storage` is full.
3.  **Action:** Enter Email -> Click Magic Link (Simulated or Real).
4.  **Verification (DB):** Check Supabase `public.posts`. Record exists for this email with correct `content` and `theme`.
5.  **Verification (Client):** Check Local Storage. `quiz-storage` should be **Empty/Cleared**.

### Scenario: The "Existing User" Flow
**ID:** TS-MAN-02

1.  **Pre-condition:** User `test@example.com` exists and has 1 post.
2.  **Action:** In Incognito, complete Quiz as anonymous.
3.  **Action:** Enter `test@example.com` in the Email Capture.
4.  **Action:** Click Magic Link -> Login.
5.  **Verification:** Dashboard should show the **NEW** post (most recent).
6.  **Verification (DB):** User `test@example.com` now has 2 posts.

### Scenario: Navigation Locking
**ID:** TS-MAN-03

1.  **Action:** Complete Quiz -> Enter Email -> Submit.
2.  **Action:** Land on "Check your email" (or Dashboard if auto-redirect).
3.  **Action:** Press Browser **Back** button.
4.  **Expected:** Should NOT return to the "Blurry Reveal" page with the email form. Should stay on current page or redirect to Home/Dashboard.

---

## 4. Test Data Requirements

To support the "Stabilization", the following test data fixtures are required in `lib/data/` or inline in tests:

*   **`mock-post-full.json`**: A complete Post object (Content, Theme, Quiz Answers, Archetype) for seeding.
*   **`admin-user`**: Access to `SUPABASE_SERVICE_ROLE_KEY` in test environment (CI/Local .env) for aggressive data cleanup/seeding.

## 5. Success Criteria for Story 2.6

*   All E2E tests in `dashboard.spec.ts` pass 3 times in a row locally.
*   Visual Snapshots are updated and stable.
*   Manual verification confirms `localStorage` is cleared after success.
