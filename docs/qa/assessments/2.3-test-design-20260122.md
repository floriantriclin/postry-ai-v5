# Design de Test - Story 2.3 : Modal de Capture & Déclenchement Auth

**Objectif :** Valider le composant de capture d'email (\`AuthModal\` / \`ConversionOverlay\`) et son intégration dans le flux d'authentification par Magic Link, en mettant l'accent sur les états UI, la validation, et les NFR (Accessibilité, Mobile).

## Stratégie de Test

| Type | Outil | Couverture | Notes |
| :--- | :--- | :--- | :--- |
| **Tests de Composant** | [Vitest](docs/qa/syntax/vitest.md) / [RTL](docs/qa/syntax/react-testing-library.md) | Logique UI, Validation Client, Gestion des États (Loading, Success, Error), Accessibilité (Focus Trap). | Testez le composant de manière isolée, en mockant la fonction d'appel API. |
| **Tests End-to-End** | [Playwright](docs/qa/syntax/playwright.md) | Intégration dans le flux complet (Quiz -> Post Flouté -> Modal), Happy Path de conversion, Responsivité Mobile. | Utilisez un viewport mobile pour le test de responsivité. |

## Cas de Test Détaillés

### 1. Tests de Composant (\`AuthModal.test.tsx\`)

**Cible :** \`AuthModal.tsx\` ou \`ConversionOverlay.tsx\`

| ID | Objectif du Test | Étapes de Vérification | Critères de Succès | Type | Risques Couverts |
| :--- | :--- | :--- | :--- | :--- | :--- |
| C2.3.1 | **Affichage Initial** | Rendre le composant. | L'input Email et le bouton CTA sont visibles. Les messages de succès et d'erreur sont masqués. | Fonctionnel | R2.3.5 |
| C2.3.2 | **Validation Email (Vide)** | 1. Tenter de soumettre un formulaire vide. | Un message d'erreur est affiché immédiatement (visuel \`Signal Orange\`). La fonction \`signInWithEmail()\` n'est pas appelée. | Négatif/UX | R2.3.2 |
| C2.3.3 | **Validation Email (Format Invalide)** | 1. Tenter de soumettre avec une chaîne invalide (ex: \`test@\` ou \`test.com\`). | Même comportement que C2.3.2. | Négatif/UX | R2.3.2 |
| C2.3.4 | **État de Chargement (\`soumission\`)** | 1. Saisir un email valide. 2. Cliquer sur soumettre et simuler une réponse API en attente. | Le bouton de soumission est désactivé. Un indicateur de chargement visuel est affiché. | Fonctionnel | R2.3.5 |
| C2.3.5 | **État de Succès** | 1. Saisir un email valide. 2. Cliquer sur soumettre et mocker une réponse API réussie. | Le message "Lien de connexion envoyé. Vérifiez votre boîte mail." est affiché. La modal ne se ferme pas. | Fonctionnel | R2.3.1, R2.3.5 |
| C2.3.6 | **État d'Erreur API** | 1. Saisir un email valide. 2. Cliquer sur soumettre et mocker une réponse API échouée. | Un message d'erreur d'API est affiché. Le bouton redevient actif. | Négatif | R2.3.1, R2.3.5 |
| C2.3.7 | **Accessibilité (Rôles ARIA)** | Vérifier la structure DOM du composant rendu. | Le composant principal de la modal possède l'attribut \`role="dialog"\`. | NFR/A11Y | R2.3.3 |
| C2.3.8 | **Accessibilité (Focus Trap)** | Tenter de tabuler au-delà des limites de la modal. | Le focus reste piégé entre les éléments interactifs de la modal (input, bouton, éventuel bouton de fermeture). | NFR/A11Y | R2.3.3 |
| C2.3.9 | **Gestion du `onClose`** | 1. Mocker la prop `onClose`. 2. Simuler un clic sur l'icône de fermeture (si elle existe). 3. Simuler une pression sur la touche `Echap`. | La fonction `onClose` est appelée à chaque action. | Fonctionnel | R2.3.5 |
| C2.3.10 | **Props `title` et `description`**| 1. Rendre le composant avec des props `title` et `description` personnalisées. | Le titre et la description fournis sont correctement affichés dans le DOM. | Fonctionnel | R2.3.5 |
| C2.3.11 | **Validation de l'Email (Caractères Spéciaux)** | 1. Saisir un email avec des caractères spéciaux valides (ex: `test.name+alias@example.co.uk`). 2. Cliquer sur soumettre et mocker une réponse API réussie. | Le formulaire est soumis avec succès. La fonction `signInWithEmail()` est appelée avec l'email correct. | Fonctionnel | R2.3.2 |

### 2. Tests End-to-End (\`e2e/auth-modal.spec.ts\`)

**Cible :** Parcours utilisateur complet sur Playwright.

| ID | Objectif du Test | Étapes de Vérification | Critères de Succès | Type | Risques Couverts |
| :--- | :--- | :--- | :--- | :--- | :--- |
| E2.3.1 | **Parcours Critique (Happy Path)** | 1. Compléter le Quiz jusqu'à la page du Post Flouté. 2. Saisir un email valide (utilisant un email jetable mocké si possible). 3. Soumettre le formulaire. | Le modal est immédiatement visible à l'arrivée sur la page (R2.3.6). L'appel API est intercepté/vérifié. Le message de succès est affiché. | Fonctionnel/Flow | R2.3.1, R2.3.6 |
| E2.3.2 | **Test de Responsivité Mobile** | 1. Configurer Playwright avec un viewport mobile (ex: \`iphone-x\`). 2. Exécuter l'étape E2.3.1 (ou simplement charger la modal). | L'UI est correctement agencée sans débordement horizontal. Les zones de clic (input/CTA) sont facilement utilisables. | NFR/UX | R2.3.4 |
| E2.3.3 | **Vérification de la Validation UI** | 1. Naviguer jusqu'à la modal. 2. Tenter de soumettre sans email. | Le message d'erreur de validation est visible immédiatement (sans appel API). | Négatif/UX | R2.3.2 |
