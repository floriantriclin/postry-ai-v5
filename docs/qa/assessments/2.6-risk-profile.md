# Risk Profile: Story 2.6 - Stabilization & Refactoring

**Parent Epic:** [Epic 2 : Conversion & Identit√©](../epics/epic-2-conversion.md)  
**Story:** [Story 2.6 : Stabilisation, Refactoring & Fiabilisation](../stories/story-2-6-stabilization-refactoring.md)  
**Date:** 24 Janvier 2026  
**Author:** QA Architect

---

## 1. Context & Complexity Assessment

This story is a **Technical Enabler** and **Stability Fix** focused on hardening the application after the rapid feature delivery of Stories 2.4 and 2.5. It addresses critical technical debt identified in the [Failure Analysis Report](../reports/failure-analysis-story-2-6-prep.md) regarding test stability and data persistence.

*   **Complexity:** **High** (Touchpoints on Auth Flow, Database Schema, State Management, and Test Infrastructure).
*   **Impact:** **Critical** (Directly affects data integrity and the ability to release confidently).
*   **Risk Level:** **High** (Refactoring core flows carries regression risks).

## 2. Risk Analysis Matrix

| Risk ID | Risk Description | Likelihood | Impact | Severity | Mitigation Strategy |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **R-2.6-01** | **Data Loss during Auth Handoff**<br>The generated post/quiz data might be lost during the transition from anonymous (local) to authenticated (server) session if the `pre-persist` logic fails. | Medium | Critical | **High** | **Defensive Persistence:** Verify DB record existence *before* clearing localStorage. Implement fallback/retry logic in the frontend. |
| **R-2.6-02** | **Existing User/Duplicate Email Conflict**<br>Users entering an existing email might trigger unique constraint violations or detach the new quiz result from the existing account. | High | High | **High** | **Upsert Logic:** Ensure the backend handles "email exists" gracefully. **Merge Strategy:** Explicitly test the "New Quiz + Existing Account" scenario. |
| **R-2.6-03** | **Zombie State on Back Navigation**<br>User clicking "Back" after magic link submission might re-submit or land in an inconsistent UI state (blurred post vs revealed post). | High | Medium | **Medium** | **Route Guards & History API:** Replace history entries (`replaceState`) instead of pushing new ones. Implement strict state checks on component mount. |
| **R-2.6-04** | **Test Infrastructure Regression**<br>Refactoring `auth.setup.ts` and data seeding could inadvertently break existing passing tests (False Negatives). | Medium | High | **High** | **Incremental Migration:** Validate the new setup on a single test suite (`dashboard.spec.ts`) before applying globally. |
| **R-2.6-05** | **"Sujet non disponible" Persistence**<br>The display bug might hide a deeper data issue where the `topic` isn't being saved to the DB, causing permanent data corruption for that record. | Medium | High | **High** | **Schema Validation:** Enforce `topic` as required in the DB schema or API validation layer. |
| **R-2.6-06** | **Race Conditions in "Smart Auth"**<br>The new test setup might introduce race conditions where the test starts before the seeded data is fully committed/indexed. | Low | Medium | **Medium** | **Explicit Waits:** Ensure the seeding function awaits database confirmation before releasing the test execution. |

## 3. Focus Areas for QA

Based on the risks, the QA effort must prioritize:

1.  **Data Integrity Verification (The "Black Box" Check):**
    *   It is not enough to check the UI. We must query the Supabase database directly to confirm:
        *   `public.posts` contains the correct `content`, `theme`, and `answers`.
        *   The record is correctly linked to `auth.users`.
        *   No orphaned records are created during "Existing User" flows.

2.  **Edge Case Flows:**
    *   **The "Returning User":** User takes quiz -> enters email of *existing* account -> clicks magic link. Does the *new* quiz appear?
    *   **The "Double Clicker":** User clicks the Magic Link button multiple times.
    *   **The "Back Button" Bandit:** User completes flow, hits Back, tries to change answers.

3.  **Test Infrastructure Stability:**
    *   Verify that `dashboard.spec.ts` passes 10/10 times locally before merging.
    *   Verify that the "Smart Auth" handles expired tokens correctly (simulated by deleting the json file or invalidating the token manually).

## 4. Recommendations for Developers

*   **Atomic Transactions:** Ensure the user creation/lookup and post saving happen ideally within a transaction or a very robust promise chain.
*   **Idempotency:** The "Data Seeding" logic in tests must be idempotent. Running it twice shouldn't fail or create duplicate blocking states.
*   **Logging:** Add specific frontend logs for the "Reveal" phase to debug why "Sujet" might be missing (e.g., `console.log('PostReveal: Data received', postData)`).
