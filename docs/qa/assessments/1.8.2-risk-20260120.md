# Analyse de Risques & Stratégie de Test pour la Story 1.8.2

## 1. Analyse des Risques

| ID | Risque | Cause Potentielle | Impact (1-5) | Probabilité (1-5) | Criticité (I*P) | Stratégie de Mitigation |
|---|---|---|---|---|---|---|
| **R1** | **Perte de Données Client (Rafraîchissement)** | Le calcul vectoriel étant local (client-side), un rafraîchissement de page ou un crash navigateur durant la phase 2 entraîne la perte de la progression intermédiaire (questions 7-11), ramenant l'utilisateur à l'interstitiel. | 3 (Modéré) | 3 (Moyenne) | 9 | Accepter ce risque pour cette itération (UX simple). L'utilisateur devra recommencer la phase 2 (courte). À terme : persistance `localStorage` du vecteur intermédiaire. |
| **R2** | **Manipulation du Vecteur Client** | Un utilisateur technique pourrait manipuler le vecteur local ou le payload final envoyé à `/profile` pour forcer un résultat spécifique, contournant la logique ICE. | 2 (Faible) | 2 (Faible) | 4 | Risque faible pour un quiz non-compétitif. Validation stricte du schéma Zod sur le payload `/profile` côté serveur (AC 2.1). |
| **R3** | **Performance Perçue Dégradée (Prefetch)** | Si l'appel de prefetching à `/generate?phase=2` est lent ou échoue, l'utilisateur subit une attente imprévue au moment de passer à la phase 2, annulant le bénéfice du pré-chargement. | 3 (Modéré) | 4 (Haute) | 12 | Tests de performance sur l'endpoint `/generate`. Simulation d'une réponse lente en E2E pour valider que l'indicateur de chargement (AC 1.3) est informatif et non bloquant. |
| **R4** | **Incohérence du Payload Final** | Si la logique client comporte un bug, le payload envoyé à `/profile` (V11) pourrait être mathématiquement incohérent avec l'archétype initial, générant un profil aberrant. | 4 (Élevé) | 2 (Faible) | 8 | Tests unitaires extensifs sur `lib/ice-logic` (client) pour garantir la conformité à la formule `Vnew = Vold + (Cible - Vold) * 0.3`. |

## 2. Plan de Test

### A. Tests Unitaires & Intégration Logique (`vitest`)

Ces tests valident la logique de calcul vectoriel partagée et l'API.

1.  **`test('Logique Client : Mise à jour Vecteur (AC 1.2)')`**
    *   **Fichier :** `lib/ice-logic.test.ts`
    *   **Scénario :** Vérifier l'application correcte de la formule de rapprochement.
    *   **Assertions :**
        *   Calculer `Vnew` pour une réponse donnée.
        *   Vérifier que le vecteur se rapproche de la cible de 30%.
        *   Vérifier que les bornes (0-100) sont respectées.

2.  **`test('API : Flux complet Phase 2 (AC 2.1)')`**
    *   **Fichier :** `app/api/quiz/orchestration.spec.ts`
    *   **Scénario :** Simule la réception du payload final.
    *   **Étapes :**
        1.  Appeler `POST /api/quiz/profile` avec un payload complet valide (Archetype, V11).
    *   **Assertions :**
        *   Vérifier que le statut de la réponse est 200 OK.
        *   Vérifier la présence de `label_final` et `definition_longue`.
        *   Valider que le serveur ne tente pas de recalculer les étapes intermédiaires (confiance au vecteur final).

### B. Tests End-to-End (E2E - `playwright`)

Ces tests simulent le parcours utilisateur complet dans un navigateur, avec un focus sur la fluidité et l'absence d'appels réseau bloquants.

1.  **`test('Parcours Phase 2 : Zéro Latence & Profil Final')`**
    *   **Scénario :** Valide l'expérience "Zero Latence" et la soumission finale.
    *   **Étapes :**
        1.  Terminer la phase 1, atteindre l'interstitiel.
        2.  **Vérifier** l'appel background `POST /generate?phase=2`.
        3.  Démarrer la Phase 2.
        4.  Répondre aux questions 7 à 11.
        5.  **Vérifier** qu'**AUCUN** appel réseau (`/refine`) n'est émis entre les questions (AC 1.2).
        6.  **Vérifier** la fluidité immédiate des transitions.
        7.  Après la Q11, **vérifier** l'émission de l'appel unique `POST /api/quiz/profile`.
        8.  Vérifier l'état de chargement "Génération de votre profil...".
        9.  Vérifier l'affichage final (100% précision, Label).

2.  **`test('Gestion de prefetching lent (AC 1.3)')`**
    *   **Scénario :** Valide l'attente active si le joueur est plus rapide que le réseau.
    *   **Étapes :**
        1.  Arriver à l'interstitiel de la phase 1.
        2.  **Intercepter** `/generate?phase=2` avec un délai de 5 secondes.
        3.  Cliquer immédiatement sur "Continuer".
    *   **Assertions :**
        *   Le bouton passe en état de chargement ou un loader apparaît.
        *   L'utilisateur reste sur l'interstitiel tant que la réponse n'est pas arrivée.
        *   Dès réception, la transition vers Q7 se fait automatiquement.
