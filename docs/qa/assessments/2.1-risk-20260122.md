# Évaluation des Risques - Story 2.1 : Configuration Base de Données

| Métadonnées | Détails |
| :--- | :--- |
| **Story** | Story 2.1 : Configuration Base de Données & Schéma Utilisateur |
| **Date** | 2026-01-22 |
| **Auteur** | BMad QA |
| **Statut** | Draft |

## 1. Analyse du Changement

La Story 2.1 pose les fondations de la persistance des données pour l'application. Elle introduit Supabase comme backend, définit les schémas critiques (`users`, `posts`) et implémente la sécurité via RLS (Row Level Security). C'est un changement structurel majeur avec un impact élevé sur la sécurité et la fiabilité.

### Composants Impactés
*   **Infrastructure :** Projet Supabase (Tables, Triggers, Policies).
*   **Configuration :** Variables d'environnement (`.env.local`).
*   **Code Client :** `lib/supabase.ts` (Singleton).
*   **Flux d'Authentification :** Le trigger `handle_new_user` couple la création de compte Auth à la création de données métier.

## 2. Matrice des Risques

| ID | Risque Identifié | Impact | Probabilité | Sévérité | Stratégie d'Atténuation |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **R-2.1-01** | **Fuite de données inter-utilisateurs (RLS défaillant)**<br>Un utilisateur peut accéder aux posts ou profils d'un autre utilisateur. | Critique | Moyenne | **Extrême** | Tests de sécurité explicites (Negative Testing) simulant des accès croisés. Review minutieuse des politiques SQL. |
| **R-2.1-02** | **Désynchronisation Auth/Public User**<br>Le trigger `handle_new_user` échoue, créant un utilisateur authentifié sans profil public associé. | Élevé | Faible | **Haute** | Test d'intégration du flux d'inscription. Logs d'erreur Supabase. |
| **R-2.1-03** | **Schéma Incorrect / Manquant**<br>Les colonnes requises (ex: `vstyle_vector`) sont absentes ou mal typées, bloquant les features futures. | Moyen | Faible | **Moyenne** | Validation du schéma post-migration. Script de seed pour valider les types. |
| **R-2.1-04** | **Problème de Connexion Client**<br>Le singleton `lib/supabase.ts` est mal configuré ou instancié multiples fois. | Moyen | Faible | **Moyenne** | Smoke test au démarrage de l'app. Vérification du pattern Singleton. |
| **R-2.1-05** | **Perte de Données (Migration)**<br>Si ré-exécution sur une base existante sans précaution (bien que peu probable en phase initiale). | Élevé | Faible | **Haute** | Utiliser des migrations idempotentes (`IF NOT EXISTS`) ou des scripts de setup clairs. |

## 3. Recommandations de Qualité

### Pré-Implémentation (Architecte)
*   S'assurer que les clés étrangères (`references auth.users`) sont en `ON DELETE CASCADE` ou gérées pour éviter les orphelins si un user est supprimé.
*   Vérifier que les types JSONB (`quiz_answers`, `equalizer_settings`) ont une structure documentée (même si NoSQL).

### Pendant le Développement
*   Tester manuellement les politiques RLS via le dashboard Supabase (impersonation) avant de coder le client.
*   Vérifier que les variables d'environnement sont bien chargées côté client (préfixe `NEXT_PUBLIC_`) et côté serveur si besoin.

### Post-Implémentation (QA)
*   Exécuter un script de "Smoke Test" qui tente de se connecter et de faire un `SELECT count(*) FROM users` (devrait être 0 ou N, mais pas erreur).

## 4. Conclusion

Le risque principal est **sécuritaire (RLS)**. Une attention particulière doit être portée à la validation que "l'utilisateur A ne voit QUE les données de A". Le reste est de la configuration standard à faible risque technique si les docs Supabase sont suivies.
