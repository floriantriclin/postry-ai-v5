# Conception des Tests - Story 2.1 : Configuration Base de Données

| Métadonnées | Détails |
| :--- | :--- |
| **Story** | Story 2.1 : Configuration Base de Données & Schéma Utilisateur |
| **Date** | 2026-01-22 |
| **Auteur** | BMad QA |
| **Statut** | Draft |

## 1. Objectifs de Test
Vérifier que l'infrastructure de données est correctement mise en place, sécurisée et accessible par l'application.

## 2. Périmètre (Scope)
*   **In Scope :**
    *   Configuration du client Supabase (`lib/supabase.ts`).
    *   Création des tables `users` et `posts`.
    *   Triggers de création d'utilisateur.
    *   Politiques de sécurité RLS (Row Level Security).
*   **Out of Scope :**
    *   L'interface utilisateur de Login/Register (sera testé dans Story 2.2/2.3).
    *   L'affichage des posts dans l'UI (Story 2.5).

## 3. Scénarios de Test (Test Cases)

### TD-2.1-01 : Configuration & Connexion (Smoke Test)
*   **Objectif :** Valider que l'application peut communiquer avec Supabase.
*   **Pré-conditions :** `.env.local` configuré.
*   **Étapes :**
    1.  Lancer l'application (`npm run dev`).
    2.  Vérifier la console pour toute erreur d'initialisation Supabase.
    3.  (Optionnel) Exécuter un script simple Node qui importe `supabase` et fait un ping.
*   **Résultat Attendu :** Pas d'erreur, connexion établie.

### TD-2.1-02 : Validation du Schéma (Structure)
*   **Objectif :** Vérifier que les tables et colonnes existent conformément aux specs.
*   **Type :** Inspection Manuelle (Dashboard Supabase) ou Script SQL.
*   **Vérifications :**
    *   Table `public.users` existe avec : `id` (PK), `email`, `credits_count`, `is_premium`, `profile_context`, `archetype`, `vstyle_vector`.
    *   Table `public.posts` existe avec : `id` (PK), `user_id` (FK), `content`, `theme`, `quiz_answers`, `equalizer_settings`, `is_revealed`.

### TD-2.1-03 : Trigger d'Inscription (Intégration)
*   **Objectif :** Vérifier qu'un utilisateur Auth génère un utilisateur Public.
*   **Étapes :**
    1.  Via le Dashboard Supabase > Authentication > Users : Ajouter un utilisateur test (`test@example.com`).
    2.  Aller dans Table Editor > `public.users`.
*   **Résultat Attendu :** Une ligne doit avoir été créée automatiquement dans `public.users` avec le même `id` et `email`. `credits_count` doit être à 5 (default).

### TD-2.1-04 : Sécurité RLS - Isolation des Données (Critique)
*   **Objectif :** S'assurer qu'un utilisateur ne voit pas les données des autres.
*   **Méthode :** Script SQL ou Client JS simulé.
*   **Scénario :**
    1.  Créer User A et User B.
    2.  Insérer Post A (appartenant à User A) et Post B (appartenant à User B).
    3.  Connecter le client en tant que User A.
    4.  Requêter `SELECT * FROM posts`.
*   **Résultat Attendu :** La requête ne retourne que Post A. Post B est invisible.

### TD-2.1-05 : Sécurité RLS - Modification (Critique)
*   **Objectif :** S'assurer qu'un utilisateur ne peut pas modifier le profil d'un autre.
*   **Scénario :**
    1.  Connecter le client en tant que User A.
    2.  Tenter `UPDATE users SET credits_count = 1000 WHERE id = [ID_USER_B]`.
*   **Résultat Attendu :** L'opération échoue (erreur RLS) ou retourne 0 ligne modifiée (selon config RLS, souvent silencieux sur 0 ligne). La valeur en base ne change pas.

## 4. Données de Test Requises
*   Deux comptes utilisateurs de test (`user_a@test.com`, `user_b@test.com`).
*   Jeux de données JSON valides pour `quiz_answers` et `vstyle_vector` (pour tester les types, optionnel à ce stade).

## 5. Environnement de Test
*   Environnement Local (`.env.local` pointant vers projet Supabase Dev).

## 6. Critères d'Acceptation (Definition of Done)
*   [ ] Connexion Supabase fonctionnelle.
*   [ ] Tables créées.
*   [ ] Trigger `handle_new_user` vérifié (1 test positif).
*   [ ] RLS vérifié (1 test positif "My Data", 1 test négatif "Other's Data").
