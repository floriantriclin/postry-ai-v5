# Test Design: Story 2.2 - Authentification par Magic Link

**Date:** 2026-01-22
**Version:** 1.0
**Story:** [Story 2.2](../stories/story-2-2-auth-magic-link.md)

## 1. Stratégie de Test

Conformément à la stratégie "Lean", nous nous concentrons sur :
1.  **Tests Unitaires (Automatisés) :** Vérification de la logique d'abstraction `lib/auth.ts` et du mapping d'erreurs.
2.  **Tests Manuels (Critiques) :** Le flux réel d'envoi d'email et de redirection, car difficile à mocker fidèlement sans infrastructure lourde.

## 2. Tests Unitaires (`lib/auth.test.ts`)

| ID | Cas de Test | Conditions | Résultat Attendu |
|:---|:---|:---|:---|
| TU-2.2-01 | **Succès `signInWithOtp`** | Email valide, Mock Supabase retourne `{ error: null }` | La fonction retourne `{ success: true }` et appelle Supabase avec `emailRedirectTo`. |
| TU-2.2-02 | **Validation Email** | Email invalide (ex: "invalid-email") | La fonction retourne une erreur de validation (Zod) sans appeler Supabase. |
| TU-2.2-03 | **Gestion Erreur Rate Limit** | Mock Supabase retourne erreur 429 | La fonction retourne une erreur typée `AuthRateLimitError`. |
| TU-2.2-04 | **Gestion Erreur Générique** | Mock Supabase retourne erreur 500 | La fonction retourne une erreur générique `AuthError`. |

## 3. Tests d'Intégration / Manuels

Ces tests doivent être exécutés localement ou en environnement de pré-production.

| ID | Scénario | Étapes | Résultat Attendu |
|:---|:---|:---|:---|
| TM-2.2-01 | **Flux Nominal (Happy Path)** | 1. Appeler `signInWithOtp` avec un email réel.<br>2. Vérifier la réception de l'email.<br>3. Cliquer sur le lien magique. | Redirection vers l'URL spécifiée (`/quiz/reveal` ou `/`). Session active (Cookie `sb-access-token` présent). |
| TM-2.2-02 | **Redirection Personnalisée** | 1. Appeler avec `redirectTo: '/dashboard'`.<br>2. Compléter le flux. | L'utilisateur atterrit sur `/dashboard` après authentification. |
| TM-2.2-03 | **Code Expiré/Invalide** | 1. Utiliser un vieux lien magique. | La page de callback redirige vers `/auth/auth-code-error` ou affiche un message clair. |
| TM-2.2-04 | **Double Consommation** | 1. Cliquer deux fois sur le même lien. | Le deuxième clic gère l'erreur gracieusement (déjà connecté ou lien invalide). |

## 4. Données de Test & Mocks

### Mock Supabase (`vitest`)
```typescript
const supabaseMock = {
  auth: {
    signInWithOtp: vi.fn()
  }
}
```

### Variables d'Environnement
- `NEXT_PUBLIC_BASE_URL` doit être configuré (ex: `http://localhost:3000` en local).
