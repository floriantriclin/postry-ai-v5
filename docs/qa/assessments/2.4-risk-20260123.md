# Évaluation des Risques - Story 2.4 : Flux de Révélation

**Date :** 2026-01-23
**Auteur :** QA Lead
**Story :** [Story 2.4 - Flux de Révélation](../stories/story-2-4-reveal-flow.md)

## 1. Analyse des Risques & Intégration SM

Cette analyse intègre les points d'attention soulevés par le Scrum Master dans le plan d'action de la Story 2.4.

| ID | Risque Identifié | Impact | Probabilité | Sévérité | Stratégie d'Atténuation (SM & QA) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **R-2.4-01** | **Incohérence des données "Cross-Device"**<br>Risque critique identifié par le SM : l'utilisateur s'inscrit sur mobile mais valide sur desktop. Si le lien `email` <-> `user_id` échoue, l'expérience est brisée. | Critique | Moyenne | **Haute** | **Validation SM :** Le trigger `on_auth_user_created` est la clé de voûte. <br>**Action QA :** Test E2E simulant ce flux + Vérification manuelle obligatoire. |
| **R-2.4-02** | **Sécurité de l'endpoint `/pre-persist`**<br>L'endpoint est public. Risque de création massive de posts "pending" (DOS/Spam). | Élevé | Moyenne | **Haute** | **Recommandation SM :** Implémenter un Rate Limiting strict et une validation Zod rigoureuse.<br>**Action QA :** Tests de charge légers et tests d'injection de payloads invalides. |
| **R-2.4-03** | **Échec de la Migration DB**<br>La migration [`20260123-update-posts-schema.md`](../architecture/migrations/20260123-update-posts-schema.md) modifie la structure de `posts`. Un échec rendrait l'écriture impossible. | Critique | Faible | **Haute** | **Validation SM :** La migration a été revue, mais l'exécution en prod reste critique.<br>**Action QA :** Vérifier le schéma après déploiement en staging. |
| **R-2.4-04** | **Blocage UX (Navigation Lock)**<br>Le "Soft Lock" (History API) demandé par le SM peut piéger l'utilisateur si mal implémenté. | Moyen | Élevée | Moyenne | **Recommandation SM :** Utiliser `pushState` avec précaution.<br>**Action QA :** Tester le bouton "Back" sur Chrome, Firefox et Safari (Mobile/Desktop). S'assurer qu'une sortie est possible. |
| **R-2.4-05** | **Magic Link Expiré**<br>L'utilisateur tarde à cliquer. Le token expire. | Moyen | Faible | Moyenne | **Action QA :** Vérifier le message d'erreur et la possibilité de redemander un lien sans perdre les données "pending" (si possible) ou régénérer le quiz. |

## 2. Zones d'Attention (Hotspots)

*   **Trigger SQL** : La logique `UPDATE public.posts SET user_id = new.id ... WHERE email = new.email` doit être atomique et infaillible.
*   **Permissions RLS** : L'endpoint utilise `supabaseAdmin` pour écrire, contournant le RLS. C'est une zone de risque de sécurité qui nécessite une isolation parfaite.
*   **Compatibilité Navigateur** : Le comportement de `window.history` varie subtilement entre les navigateurs mobiles.

## 3. Recommandations QA Prioritaires

1.  **Test E2E "Happy Path" Complet** : Génération -> Pre-persist -> Auth -> Redirection -> Reveal. C'est le contrat de base.
2.  **Validation de la Sécurité API** : Tester que l'endpoint `/pre-persist` refuse les données incomplètes ou mal formées (Validation Zod).
3.  **Vérification de la Migration** : S'assurer que les posts existants (s'il y en a) ne sont pas corrompus par la migration (champs nullable).
