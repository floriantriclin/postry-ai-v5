# Test Plan: Story 1.8.3 - UX "Tech & Brut" & Robustness

**Date:** 2026-01-20
**Story:** [Story 1.8.3](../../stories/story-1-8-3-ux-robustness.md)
**Scope:** Client-side Persistence (`useQuizPersistence`), UI Animations (`LoaderMachine`), and Error Feedback.

## 1. Test Strategy

| Component | Type | Tool | Focus |
|-----------|------|------|-------|
| `useQuizPersistence` | Unit | Vitest | State hydration, Schema validation, Storage limits. |
| `LoaderMachine` | Component | Storybook / Manual | Visual correctness, A11y (reduced motion). |
| `QuizEngine` (Integration) | E2E | Playwright | Reload persistence, Browser navigation. |
| Error Toast | Manual/E2E | Playwright | Styling verification in degraded mode. |

## 2. Test Cases

### 2.1. Unit Tests (Vitest) - `hooks/use-quiz-persistence.test.ts`

*   **TC-UNIT-01: Save State:** Verify that changes to the reducer state (answering a question) update `localStorage`.
*   **TC-UNIT-02: Hydrate State:** Verify that initializing the hook reads from `localStorage` and restores the correct step/answers.
*   **TC-UNIT-03: Invalid State:** Verify that corrupted JSON in `localStorage` is ignored (graceful fallback to initial state) and clears the storage.
*   **TC-UNIT-04: Version Mismatch (Recommendation):** If implemented, verify that old state versions are discarded.

### 2.2. E2E Tests (Playwright) - `e2e/quiz-robustness.spec.ts`

This is a new test file dedicated to session reliability.

*   **TC-E2E-01: Reload Persistence**
    1.  Start Quiz.
    2.  Answer 3 questions.
    3.  Assert current question is #4.
    4.  Trigger `page.reload()`.
    5.  **Expect:** Quiz resumes immediately at question #4.
    6.  **Expect:** Previous answers are still recorded in the summary (if visible) or internal state.

*   **TC-E2E-02: Tab Close & Reopen (Session)**
    1.  Start Quiz.
    2.  Answer 1 question.
    3.  Open new tab to same URL.
    4.  **Expect:** Quiz resumes at question #2.

*   **TC-E2E-03: Degraded Mode UI**
    1.  Mock API failure for `submitAnswer`.
    2.  User clicks answer.
    3.  **Expect:** "Tech" styled Toast appears (Orange border, Monospace font).
    4.  **Expect:** UI does not freeze.

### 2.3. UX & Visual Validation (Manual)

*   **TC-UX-01: Loader Machine:** Verify the loader displays the specific "BOOTING..." sequences and not a generic spinner.
*   **TC-UX-02: Snap Transitions:** Verify transitions are ~100ms and feel "snappy" rather than floating.
*   **TC-UX-03: Digital Counter:** Verify counter format is `[ 04 / 11 ]` (monospaced brackets).

## 3. Automation Implementation Plan

### 3.1. New Test File: `e2e/quiz-robustness.spec.ts`
```typescript
import { test, expect } from '@playwright/test';

test.describe('Quiz Robustness & Persistence', () => {
  test('should persist progress after page reload', async ({ page }) => {
    // 1. Navigate and Start
    await page.goto('/quiz');
    // ... complete step 1 ...

    // 2. Verify progress
    await expect(page.getByText('Question 2')).toBeVisible();

    // 3. Reload
    await page.reload();

    // 4. Assert State Preserved
    await expect(page.getByText('Question 2')).toBeVisible();
  });
});
```

### 3.2. Mocking for Error State
Use `page.route` to force 500 errors to test the "Tech" Toast appearance.

## 4. Acceptance Criteria Checklist
- [ ] Persistence passes `TC-E2E-01` (Reload).
- [ ] `localStorage` logic handles corrupted data gracefully.
- [ ] "Tech" Loader replaces all system spinners.
- [ ] Error Toasts match the "Brut" design spec.
