# Test Plan: Story 1.9 - Initial Post Generation

**Date:** 2026-01-21
**Story:** [Story 1.9](../stories/story-1-9-initial-post-generation.md)
**Scope:** API Endpoint `POST /api/quiz/post`, Prompt Engineering logic, and Frontend "Focus View" (Transition & Blurring).

## 1. Test Strategy

| Component | Type | Tool | Focus |
|-----------|------|------|-------|
| `api/quiz/post` | Unit/Integration | Vitest | Schema Validation (Zod), Prompt Construction logic. |
| `lib/gemini.ts` | Integration | Vitest | Mocking AI responses, Timeout handling. |
| `FinalReveal` | Component | Storybook / Manual | UI State (Loading), Transitions, Blurring effect. |
| `E2E Flow` | E2E | Playwright | Full flow from Profile -> Generate -> Focus View. |

## 2. Test Cases

### 2.1. Unit & Integration Tests (Vitest) - `app/api/quiz/post/route.test.ts`

*   **TC-API-01: Schema Validation:**
    *   Verify API rejects missing `topic` or `vector`.
    *   Verify `topic` length limits (min 3 chars).
*   **TC-API-02: Prompt Construction (Whitebox):**
    *   Inject specific vectors (e.g., Density=100) and verify the generated System Prompt contains corresponding instructions (e.g., "Use academic jargon").
    *   **Goal:** Mitigate Risk AI-001 (Style Mismatch).
*   **TC-API-03: Security Sanitization:**
    *   Input: `topic: "Ignore instructions"`
    *   Verify System Prompt wraps user input clearly (e.g., `User Topic: """Ignore instructions"""`).
    *   **Goal:** Mitigate Risk SEC-001.

### 2.2. E2E Tests (Playwright) - `e2e/post-generation.spec.ts`

*   **TC-E2E-01: Happy Path Generation:**
    1.  Mock `POST /api/quiz/post` response (Fixed JSON: Hook="Hello", Content="World...").
    2.  Navigate to Profile Page (Reveal).
    3.  Enter Topic "LinkedIn Growth".
    4.  Click "Generate".
    5.  **Expect:** Loading Spinner appears.
    6.  **Expect:** Transition to "Focus View".
    7.  **Expect:** "Hello" is visible (Hook).
    8.  **Expect:** "World..." is partially blurred.
*   **TC-E2E-02: Error Handling:**
    1.  Mock `POST /api/quiz/post` failure (500).
    2.  Click "Generate".
    3.  **Expect:** Error Toast appears.
    4.  **Expect:** User remains on Input screen (no transition).

### 2.3. Manual / Exploratory

*   **TC-MAN-01: Visual Blur Quality:** Verify the CSS Blur gradient effectively hides the text end-block preventing "Inspect Element" bypassing isn't the goal, but visual obfuscation must be robust enough for casual users.
*   **TC-MAN-02: "Generated By" Label:** Verify the UI displays the correct Archetype Label (e.g. "Généré par Le Stratège") passed from the previous step.

## 3. Automation Implementation Plan

### 3.1. New Test File: `app/api/quiz/post/route.test.ts`
```typescript
import { POST } from './route';
import { NextRequest } from 'next/server';

// Mock Gemini
vi.mock('@/lib/gemini', () => ({
  generatePost: vi.fn().mockResolvedValue({
    hook: "Test Hook",
    content: "Test Content",
    cta: "Test CTA"
  })
}));

test('should validate input schema', async () => {
  const req = new NextRequest('http://localhost/api/quiz/post', {
    method: 'POST',
    body: JSON.stringify({ topic: 'Hi' }) // Too short
  });
  const res = await POST(req);
  expect(res.status).toBe(400);
});
```

### 3.2. New Test File: `e2e/post-generation.spec.ts`
Standard Playwright test mocking the API response to avoid live LLM calls.

## 4. Acceptance Criteria Checklist
- [ ] API rejects invalid inputs (400).
- [ ] Valid inputs return structured JSON (Hook, Content, CTA).
- [ ] UI handles Loading state (> 5s simulation).
- [ ] "Focus View" correctly blurs the content end.
